<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>êµì‹¤í˜• ìë¦¬ë°°ì¹˜í‘œ 30ëª… (ëª¨ë‘  í…œí”Œë¦¿)</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    .seat-card { user-select: none; }
    .dragging { opacity: .55; transform: scale(.98); }
    .drop-hint { outline: 3px dashed rgba(99,102,241,.65); outline-offset: 3px; }

    .aisle-cell {
      background: transparent !important;
      border: 1px dashed rgba(148,163,184,.25);
    }
    .empty-cell {
      background: rgba(255,255,255,.02);
      border: 1px dashed rgba(148,163,184,.18);
    }
    .is-seat-hidden { opacity: .25; filter: grayscale(1); }

    /* print */
    @media print {
      .no-print { display: none !important; }
      body { background: #fff !important; color: #111827 !important; }
      .print-text-dark { color: #111827 !important; }
      #classroomShell { box-shadow: none !important; border: 1px solid #ddd !important; }
      .glass { background: #fff !important; }
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-slate-100">
  <div class="container py-4 py-lg-5">

    <!-- Header -->
    <div class="d-flex flex-column flex-lg-row align-items-lg-end justify-content-between gap-3 mb-4">
      <div>
        <div class="inline-flex items-center gap-2 rounded-full bg-white/5 px-3 py-1 text-xs text-slate-300 border border-white/10">
          <span class="inline-block h-2 w-2 rounded-full bg-emerald-400"></span>
          Real Classroom Layout + Group Templates
        </div>
        <h1 class="mt-2 text-2xl md:text-3xl font-bold tracking-tight">
          êµì‹¤í˜• ìë¦¬ë°°ì¹˜í‘œ <span class="text-indigo-300">30ëª…</span>
        </h1>
        <p class="text-slate-300 mt-1 mb-0">
          ì´ë¦„ í´ë¦­ â†’ ìˆ˜ì • / ë“œë˜ê·¸ â†’ ìë¦¬ ì´ë™ / ì €ì¥ â†’ ë‹¤ìŒì—ë„ ê·¸ëŒ€ë¡œ
        </p>
      </div>

      <!-- Controls -->
      <div class="no-print d-flex flex-wrap gap-2">
        <button id="btnTitle" class="btn btn-outline-light">ğŸ§¾ ìˆ˜ì—… ì œëª©</button>

        <!-- NEW: Templates -->
        <div class="btn-group" role="group" aria-label="templates">
          <button id="btnTplLecture" class="btn btn-outline-info">ğŸ« ê°•ì˜ì‹</button>
          <button id="btnTplGroup4" class="btn btn-outline-info">ğŸ§© 4ì¸ ëª¨ë‘ </button>
          <button id="btnTplGroup6" class="btn btn-outline-info">ğŸ§© 6ì¸ ëª¨ë‘ </button>
        </div>

        <button id="btnEditAll" class="btn btn-light">âœï¸ ì „ì²´ ì´ë¦„ ì…ë ¥</button>
        <button id="btnShuffle" class="btn btn-warning">ğŸ”€ ëœë¤ ì„ê¸°</button>
        <button id="btnSave" class="btn btn-primary">ğŸ’¾ ì €ì¥</button>
        <button id="btnLoad" class="btn btn-outline-light">â¤µï¸ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button id="btnExport" class="btn btn-outline-info">â¬‡ï¸ CSV</button>
        <button id="btnPrint" class="btn btn-success">ğŸ–¨ï¸ ì¸ì‡„</button>
        <button id="btnReset" class="btn btn-outline-danger">â™»ï¸ ì´ˆê¸°í™”</button>
      </div>
    </div>

    <!-- Classroom Shell -->
    <div id="classroomShell"
      class="rounded-4 border border-white/10 bg-white/5 backdrop-blur shadow-[0_20px_60px_-25px_rgba(0,0,0,.75)] overflow-hidden">

      <!-- Front (Board) -->
      <div class="relative px-3 px-md-4 py-3 border-b border-white/10 bg-gradient-to-r from-emerald-500/10 via-lime-500/5 to-cyan-500/10">
        <div class="d-flex align-items-center justify-content-between gap-3">
          <div class="d-flex align-items-center gap-2">
            <div class="rounded-3 bg-black/40 border border-white/10 px-3 py-2 shadow-inner">
              <div class="text-xs text-emerald-200/90">ì¹ íŒ</div>
              <div id="classTitle" class="text-sm font-semibold text-slate-100 print-text-dark">ì •ë³´ ìˆ˜ì—…</div>
              <div id="layoutBadge" class="mt-1 text-[11px] text-slate-300">ë ˆì´ì•„ì›ƒ: ê°•ì˜ì‹</div>
            </div>
            <div class="text-xs text-slate-300">
              ì¢Œì¸¡: ì¶œì…ë¬¸ / ìš°ì¸¡: ì°½ë¬¸ / ê°€ìš´ë°: í†µë¡œ(ëª¨ë‘  í…œí”Œë¦¿ì€ ìë™)
            </div>
          </div>

          <!-- Layout controls (lecture only; still visible but optional) -->
          <div class="no-print d-flex align-items-center gap-2">
            <label class="text-xs text-slate-300 mb-0">í–‰</label>
            <input id="rows" type="number" min="1" max="10" value="5"
              class="form-control form-control-sm w-[76px] bg-white/10 text-slate-100 border-white/10" />
            <label class="text-xs text-slate-300 mb-0">ì¢Œì„ì—´</label>
            <input id="seatCols" type="number" min="2" max="10" value="6"
              class="form-control form-control-sm w-[76px] bg-white/10 text-slate-100 border-white/10" />
            <label class="text-xs text-slate-300 mb-0">í†µë¡œí­</label>
            <select id="aisleW"
              class="form-select form-select-sm w-[92px] bg-white/10 text-slate-100 border-white/10">
              <option value="1" selected>1ì¹¸</option>
              <option value="2">2ì¹¸</option>
              <option value="0">ì—†ìŒ</option>
            </select>
            <button id="btnApplyLectureLayout" class="btn btn-sm btn-outline-light">ì ìš©</button>
          </div>
        </div>
      </div>

      <!-- Middle: room frame with door/windows -->
      <div class="grid grid-cols-12 gap-0">
        <!-- Left side: Door -->
        <div class="col-span-2 border-r border-white/10 bg-white/3 p-3 md:p-4">
          <div class="rounded-4 border border-white/10 bg-gradient-to-b from-amber-500/10 to-rose-500/5 p-3">
            <div class="text-xs text-amber-200/90">ì¶œì…ë¬¸</div>
            <div class="mt-2 rounded-3 border border-white/10 bg-black/20 p-3">
              <div class="h-20 rounded-3 bg-amber-300/10 border border-amber-300/20"></div>
              <div class="mt-2 text-[11px] text-slate-300">ğŸ”’ ë¬¸ ì†ì¡ì´ â†’</div>
            </div>
          </div>

          <div class="mt-3 rounded-4 border border-white/10 bg-white/5 p-3 text-[11px] text-slate-300">
            <div class="font-semibold text-slate-200">ë¹ ë¥¸ íŒ</div>
            <ul class="mt-2 mb-0 list-disc ps-4">
              <li>ì´ë¦„ í´ë¦­: ìˆ˜ì •</li>
              <li>ë“œë˜ê·¸: ìë¦¬êµí™˜</li>
              <li>í…œí”Œë¦¿: ëª¨ë‘ /ê°•ì˜ì‹</li>
            </ul>
          </div>
        </div>

        <!-- Center: Seats + teacher desk -->
        <div class="col-span-8 p-3 p-md-4">
          <!-- Teacher desk -->
          <div class="mb-3">
            <div class="rounded-4 border border-white/10 bg-gradient-to-r from-indigo-500/15 to-cyan-500/10 p-3">
              <div class="d-flex align-items-center justify-content-between gap-3">
                <div class="d-flex align-items-center gap-2">
                  <div class="rounded-3 bg-white/10 border border-white/10 px-2 py-1 text-xs text-slate-200">
                    ğŸ‘©â€ğŸ« êµíƒ
                  </div>
                  <div class="text-xs text-slate-300">ì „ë©´(ì¹ íŒ ì•„ë˜)</div>
                </div>
                <div class="no-print d-flex align-items-center gap-2">
                  <button id="btnAbsentMode" class="btn btn-sm btn-outline-warning">ğŸš« ê²°ì„/ë¹„í™œì„± í† ê¸€</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Seats grid -->
          <div class="rounded-4 border border-white/10 bg-white/5 p-3 md:p-4 shadow-[0_10px_30px_-20px_rgba(0,0,0,.8)]">
            <div id="seats" class="grid gap-3"></div>
            <div class="mt-3 text-xs text-slate-400">
              ğŸ’¡ ì ì„  ì¹¸ì€ í†µë¡œ/ê°„ê²©(ìë¦¬ ì•„ë‹˜)ì…ë‹ˆë‹¤. ëª¨ë‘  í…œí”Œë¦¿ì€ í†µë¡œê°€ ìë™ ìƒì„±ë©ë‹ˆë‹¤.
            </div>
          </div>
        </div>

        <!-- Right side: Windows -->
        <div class="col-span-2 border-l border-white/10 bg-white/3 p-3 md:p-4">
          <div class="rounded-4 border border-white/10 bg-gradient-to-b from-sky-500/10 to-indigo-500/5 p-3">
            <div class="text-xs text-sky-200/90">ì°½ë¬¸</div>
            <div class="mt-2 grid gap-2">
              <div class="glass rounded-3 border border-white/10 bg-white/10 p-3">
                <div class="h-10 rounded-3 bg-sky-300/10 border border-sky-300/20"></div>
              </div>
              <div class="glass rounded-3 border border-white/10 bg-white/10 p-3">
                <div class="h-10 rounded-3 bg-sky-300/10 border border-sky-300/20"></div>
              </div>
              <div class="glass rounded-3 border border-white/10 bg-white/10 p-3">
                <div class="h-10 rounded-3 bg-sky-300/10 border border-sky-300/20"></div>
              </div>
            </div>
            <div class="mt-2 text-[11px] text-slate-300">ğŸŒ¤ï¸ ì±„ê´‘ ì¢‹ì€ ìë¦¬</div>
          </div>

          <div class="mt-3 rounded-4 border border-white/10 bg-white/5 p-3 text-[11px] text-slate-300">
            <div class="font-semibold text-slate-200">ì¸ì‡„ íŒ</div>
            <div class="mt-2">ì¸ì‡„ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ êµì‹¤ í”„ë ˆì„ê¹Œì§€ í•¨ê»˜ ì¶œë ¥ë©ë‹ˆë‹¤.</div>
          </div>
        </div>
      </div>

      <!-- Footer bar -->
      <div class="px-3 px-md-4 py-3 border-t border-white/10 text-xs text-slate-400">
        ì €ì¥ í‚¤: <span class="text-slate-200">localStorage</span> Â· CSV/ì¸ì‡„ ì§€ì› Â· ë””ìì¸: Bootstrap + Tailwind + SweetAlert2
      </div>
    </div>
  </div>

<script>
  const TOTAL = 30;
  const STORAGE_KEY = "classroom_seating_v3_group_templates";

  const elSeats = document.getElementById("seats");
  const elRows = document.getElementById("rows");
  const elSeatCols = document.getElementById("seatCols");
  const elAisleW = document.getElementById("aisleW");
  const elTitle = document.getElementById("classTitle");
  const elBadge = document.getElementById("layoutBadge");

  let absentMode = false;

  // layoutMode: "lecture" | "group4" | "group6"
  let state = {
    title: "ì •ë³´ ìˆ˜ì—…",
    layoutMode: "lecture",

    // lecture params
    rows: 5,
    seatCols: 6,
    aisleW: 1,

    seats: Array.from({ length: TOTAL }, (_, i) => ({
      id: i + 1,
      name: `í•™ìƒ ${String(i + 1).padStart(2, "0")}`,
      inactive: false
    }))
  };

  function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  /* ---------------------------
     DISPLAY MATRIX GENERATORS
     cell: {type:"seat", seatIndex:number} | {type:"aisle"} | {type:"empty"}
  ---------------------------- */

  function setGridColumns(cols) {
    elSeats.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
  }

  // Lecture display
  function buildLectureMatrix() {
    const seatCols = state.seatCols;
    const rows = state.rows;
    const aisleW = state.aisleW;

    const totalCols = seatCols + aisleW;
    const aisleStart = Math.floor(seatCols / 2);

    const capacity = seatCols * rows;
    if (capacity < TOTAL) return { cols: totalCols, matrix: [[{type:"empty"}]] };

    let seatCursor = 0;
    const matrix = [];

    for (let r = 0; r < rows; r++) {
      const row = [];
      for (let c = 0; c < totalCols; c++) {
        const isAisle = (aisleW > 0) && (c >= aisleStart) && (c < aisleStart + aisleW);
        if (isAisle) {
          row.push({ type: "aisle" });
        } else {
          if (seatCursor < capacity) {
            if (seatCursor < TOTAL) row.push({ type: "seat", seatIndex: seatCursor });
            else row.push({ type: "empty" });
            seatCursor++;
          } else {
            row.push({ type: "empty" });
          }
        }
      }
      matrix.push(row);
    }

    return { cols: totalCols, matrix };
  }

  // Group templates:
  // - group4: islands of 2x2 seats
  // - group6: islands of 2x3 seats
  // We auto-create aisles between islands and between island-rows.
  function buildGroupMatrix(groupSize) {
    // island footprint
    const islandRows = 2;
    const islandCols = (groupSize === 4) ? 2 : 3;

    // layout tuning
    const islandsPerRow = (groupSize === 4) ? 4 : 3; // 4*(2col) fits well, 3*(3col) fits well
    const aisleX = 1;  // vertical aisle width between islands
    const aisleY = 1;  // horizontal aisle height between island rows

    const islandCount = Math.ceil(TOTAL / groupSize); // 4ì¸: 8ì„¬(32cap), 6ì¸: 5ì„¬(30cap)
    const rowBlocks = Math.ceil(islandCount / islandsPerRow);

    const cols =
      islandsPerRow * islandCols + (islandsPerRow - 1) * aisleX;

    const rows =
      rowBlocks * islandRows + (rowBlocks - 1) * aisleY;

    // build empty matrix
    const matrix = Array.from({ length: rows }, () =>
      Array.from({ length: cols }, () => ({ type: "empty" }))
    );

    // place islands
    let seatCursor = 0;
    for (let b = 0; b < rowBlocks; b++) {
      for (let k = 0; k < islandsPerRow; k++) {
        const islandIndex = b * islandsPerRow + k;
        if (islandIndex >= islandCount) break;

        const startR = b * (islandRows + aisleY);
        const startC = k * (islandCols + aisleX);

        // Fill island seats
        for (let r = 0; r < islandRows; r++) {
          for (let c = 0; c < islandCols; c++) {
            if (seatCursor < TOTAL) {
              matrix[startR + r][startC + c] = { type: "seat", seatIndex: seatCursor };
              seatCursor++;
            } else {
              matrix[startR + r][startC + c] = { type: "empty" };
            }
          }
        }
      }
    }

    // Convert the "gaps" between islands to aisle cells (visual)
    // Vertical aisles
    for (let k = 1; k < islandsPerRow; k++) {
      const aisleColStart = k * islandCols + (k - 1) * aisleX;
      for (let r = 0; r < rows; r++) {
        for (let a = 0; a < aisleX; a++) {
          matrix[r][aisleColStart + a] = { type: "aisle" };
        }
      }
    }
    // Horizontal aisles
    for (let b = 1; b < rowBlocks; b++) {
      const aisleRowStart = b * islandRows + (b - 1) * aisleY;
      for (let c = 0; c < cols; c++) {
        for (let a = 0; a < aisleY; a++) {
          matrix[aisleRowStart + a][c] = { type: "aisle" };
        }
      }
    }

    return { cols, matrix };
  }

  function getDisplay() {
    if (state.layoutMode === "group4") return buildGroupMatrix(4);
    if (state.layoutMode === "group6") return buildGroupMatrix(6);
    return buildLectureMatrix();
  }

  /* ---------------------------
     RENDER + INTERACTION
  ---------------------------- */

  function render() {
    elTitle.textContent = state.title;

    const badgeText =
      state.layoutMode === "group4" ? "ë ˆì´ì•„ì›ƒ: 4ì¸ ëª¨ë‘ (ì„¬)" :
      state.layoutMode === "group6" ? "ë ˆì´ì•„ì›ƒ: 6ì¸ ëª¨ë‘ (ì„¬)" :
      `ë ˆì´ì•„ì›ƒ: ê°•ì˜ì‹ (${state.seatCols}Ã—${state.rows}, í†µë¡œ ${state.aisleW})`;
    elBadge.textContent = badgeText;

    const { cols, matrix } = getDisplay();
    setGridColumns(cols);

    elSeats.innerHTML = "";

    for (const row of matrix) {
      for (const cell of row) {
        if (cell.type === "aisle") {
          const div = document.createElement("div");
          div.className = "aisle-cell rounded-4 p-3";
          div.innerHTML = `
            <div class="text-[10px] text-slate-400">í†µë¡œ</div>
            <div class="mt-2 h-10 rounded-3 border border-white/10 bg-white/5"></div>
          `;
          elSeats.appendChild(div);
          continue;
        }

        if (cell.type === "empty") {
          const div = document.createElement("div");
          div.className = "empty-cell rounded-4 p-3";
          div.innerHTML = `
            <div class="text-xs text-slate-400">ë¹ˆ ì¹¸</div>
            <div class="mt-2 text-[11px] text-slate-500">(ê³µê°„/ê°„ê²©)</div>
          `;
          elSeats.appendChild(div);
          continue;
        }

        // seat
        const idx = cell.seatIndex;
        const seat = state.seats[idx];

        const card = document.createElement("button");
        card.type = "button";
        card.className = [
          "seat-card",
          "text-start",
          "rounded-4",
          "border",
          "border-white/10",
          "bg-white/5",
          "hover:bg-white/10",
          "transition",
          "p-3",
          "shadow-[0_10px_30px_-20px_rgba(0,0,0,.8)]",
          "focus:outline-none",
          "focus:ring-2",
          "focus:ring-indigo-400/60",
          seat.inactive ? "is-seat-hidden" : ""
        ].join(" ");

        card.setAttribute("draggable", "true");
        card.dataset.index = String(idx);

        card.innerHTML = `
          <div class="d-flex align-items-center justify-content-between gap-2">
            <div class="text-xs text-slate-300">ì¢Œì„ ${seat.id}</div>
            <div class="text-[10px] px-2 py-1 rounded-full bg-indigo-400/10 border border-indigo-300/20 text-indigo-200">
              drag
            </div>
          </div>
          <div class="mt-2 text-base md:text-lg font-semibold text-slate-100 leading-tight print-text-dark">
            ${escapeHtml(seat.name)}
          </div>
          <div class="mt-1 text-xs text-slate-400">
            ${seat.inactive ? "ğŸš« ë¹„í™œì„±(ê²°ì„)" : (absentMode ? "í´ë¦­: ê²°ì„ í† ê¸€" : "í´ë¦­: ì´ë¦„ ìˆ˜ì •")}
          </div>
        `;

        card.addEventListener("click", () => {
          if (absentMode) toggleInactive(idx);
          else editSeatName(idx);
        });

        card.addEventListener("dragstart", (e) => {
          card.classList.add("dragging");
          e.dataTransfer.setData("text/plain", String(idx));
          e.dataTransfer.effectAllowed = "move";
        });
        card.addEventListener("dragend", () => {
          card.classList.remove("dragging");
          document.querySelectorAll(".drop-hint").forEach(x => x.classList.remove("drop-hint"));
        });

        card.addEventListener("dragover", (e) => {
          e.preventDefault();
          card.classList.add("drop-hint");
          e.dataTransfer.dropEffect = "move";
        });
        card.addEventListener("dragleave", () => card.classList.remove("drop-hint"));

        card.addEventListener("drop", (e) => {
          e.preventDefault();
          card.classList.remove("drop-hint");
          const from = Number(e.dataTransfer.getData("text/plain"));
          const to = idx;
          if (Number.isNaN(from) || from === to) return;
          swapSeats(from, to);
        });

        elSeats.appendChild(card);
      }
    }
  }

  function swapSeats(i, j) {
    const next = [...state.seats];
    [next[i], next[j]] = [next[j], next[i]];
    state.seats = next;
    render();
  }

  function toggleInactive(index) {
    state.seats[index] = { ...state.seats[index], inactive: !state.seats[index].inactive };
    render();
  }

  async function editSeatName(index) {
    const seat = state.seats[index];
    const { value, isConfirmed } = await Swal.fire({
      title: `ì¢Œì„ ${seat.id} ì´ë¦„ ìˆ˜ì •`,
      input: "text",
      inputValue: seat.name,
      inputPlaceholder: "í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”",
      showCancelButton: true,
      confirmButtonText: "ì €ì¥",
      cancelButtonText: "ì·¨ì†Œ",
      background: "#0b1220",
      color: "#e5e7eb",
      inputAttributes: { maxlength: 30 },
      customClass: {
        popup: "rounded-4 border border-white/10",
        confirmButton: "btn btn-primary",
        cancelButton: "btn btn-outline-light ms-2"
      },
      buttonsStyling: false,
      preConfirm: (v) => {
        const t = (v ?? "").trim();
        if (!t) { Swal.showValidationMessage("ì´ë¦„ì´ ë¹„ì–´ìˆìœ¼ë©´ ì•ˆ ë©ë‹ˆë‹¤."); return false; }
        return t;
      }
    });
    if (!isConfirmed) return;
    state.seats[index] = { ...seat, name: value };
    render();
  }

  async function editAllNames() {
    const current = state.seats.map(s => s.name).join("\n");
    const { value, isConfirmed } = await Swal.fire({
      title: "ì „ì²´ ì´ë¦„ ì…ë ¥",
      html: `<div class="text-slate-300 text-sm mb-2">ì¤„ë°”ê¿ˆ(Enter)ìœ¼ë¡œ 30ëª… ì´ë¦„ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</div>`,
      input: "textarea",
      inputValue: current,
      inputPlaceholder: "ì˜ˆ) í™ê¸¸ë™\nê¹€ì² ìˆ˜\nì´ì˜í¬ ...",
      inputAttributes: { rows: 12 },
      showCancelButton: true,
      confirmButtonText: "ì ìš©",
      cancelButtonText: "ì·¨ì†Œ",
      background: "#0b1220",
      color: "#e5e7eb",
      customClass: {
        popup: "rounded-4 border border-white/10",
        confirmButton: "btn btn-primary",
        cancelButton: "btn btn-outline-light ms-2"
      },
      buttonsStyling: false,
      preConfirm: (txt) => {
        const lines = (txt ?? "").split("\n").map(s => s.trim()).filter(Boolean);
        if (lines.length !== TOTAL) {
          Swal.showValidationMessage(`ì´ë¦„ì´ ${TOTAL}ì¤„ì´ì–´ì•¼ í•©ë‹ˆë‹¤. (í˜„ì¬ ${lines.length}ì¤„)`);
          return false;
        }
        return lines;
      }
    });
    if (!isConfirmed) return;
    state.seats = state.seats.map((s, i) => ({ ...s, name: value[i] }));
    render();
    Swal.fire({ icon:"success", title:"ì ìš© ì™„ë£Œ!", timer:1100, showConfirmButton:false, background:"#0b1220", color:"#e5e7eb" });
  }

  async function shuffleSeats() {
    const result = await Swal.fire({
      title: "ëœë¤ìœ¼ë¡œ ì„ì„ê¹Œìš”?",
      html: `<div class="text-slate-300 text-sm">ë¹„í™œì„±(ê²°ì„) ì¢Œì„ì€ ê·¸ëŒ€ë¡œ ë‘ê³ , í™œì„± í•™ìƒë§Œ ì„ìŠµë‹ˆë‹¤.</div>`,
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "í™œì„±ë§Œ ì„ê¸°",
      cancelButtonText: "ì·¨ì†Œ",
      background: "#0b1220",
      color: "#e5e7eb",
      customClass: {
        popup: "rounded-4 border border-white/10",
        confirmButton: "btn btn-warning",
        cancelButton: "btn btn-outline-light ms-2"
      },
      buttonsStyling: false
    });
    if (!result.isConfirmed) return;

    const indices = state.seats.map((s,i)=>({s,i})).filter(x=>!x.s.inactive).map(x=>x.i);
    const names = indices.map(i => state.seats[i].name);

    for (let i = names.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [names[i], names[j]] = [names[j], names[i]];
    }

    const next = [...state.seats];
    indices.forEach((seatIndex, k) => next[seatIndex] = { ...next[seatIndex], name: names[k] });
    state.seats = next;
    render();

    Swal.fire({ icon:"success", title:"ì„ê¸° ì™„ë£Œ!", timer:900, showConfirmButton:false, background:"#0b1220", color:"#e5e7eb" });
  }

  function save() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    Swal.fire({ icon:"success", title:"ì €ì¥ ì™„ë£Œ", text:"ì´ ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", timer:1200, showConfirmButton:false, background:"#0b1220", color:"#e5e7eb" });
  }

  async function load() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) {
      Swal.fire({ icon:"info", title:"ì €ì¥ëœ ë°ì´í„° ì—†ìŒ", text:"ë¨¼ì € ì €ì¥ì„ í•´ì£¼ì„¸ìš”.", background:"#0b1220", color:"#e5e7eb" });
      return;
    }

    const result = await Swal.fire({
      title: "ë¶ˆëŸ¬ì˜¬ê¹Œìš”?",
      text: "ì €ì¥ëœ ìë¦¬ë°°ì¹˜ë¡œ í˜„ì¬ í™”ë©´ì´ ë°”ë€ë‹ˆë‹¤.",
      icon: "question",
      showCancelButton: true,
      confirmButtonText: "ë¶ˆëŸ¬ì˜¤ê¸°",
      cancelButtonText: "ì·¨ì†Œ",
      background: "#0b1220",
      color: "#e5e7eb",
      customClass: { popup:"rounded-4 border border-white/10", confirmButton:"btn btn-primary", cancelButton:"btn btn-outline-light ms-2" },
      buttonsStyling: false
    });
    if (!result.isConfirmed) return;

    try {
      const parsed = JSON.parse(raw);
      if (!parsed?.seats || !Array.isArray(parsed.seats) || parsed.seats.length !== TOTAL) throw new Error("invalid");

      state = {
        title: String(parsed.title ?? "ì •ë³´ ìˆ˜ì—…").slice(0, 40),
        layoutMode: (parsed.layoutMode === "group4" || parsed.layoutMode === "group6") ? parsed.layoutMode : "lecture",
        rows: clamp(Number(parsed.rows ?? 5), 1, 10),
        seatCols: clamp(Number(parsed.seatCols ?? 6), 2, 10),
        aisleW: clamp(Number(parsed.aisleW ?? 1), 0, 2),
        seats: parsed.seats.map((s,i)=>({
          id: i+1,
          name: String(s.name ?? `í•™ìƒ ${String(i+1).padStart(2,"0")}`).slice(0,30),
          inactive: Boolean(s.inactive ?? false)
        }))
      };

      elRows.value = state.rows;
      elSeatCols.value = state.seatCols;
      elAisleW.value = String(state.aisleW);

      render();
      Swal.fire({ icon:"success", title:"ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ", timer:1000, showConfirmButton:false, background:"#0b1220", color:"#e5e7eb" });
    } catch {
      Swal.fire({ icon:"error", title:"ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", text:"ì €ì¥ ë°ì´í„°ê°€ ì†ìƒë˜ì—ˆê±°ë‚˜ í˜•ì‹ì´ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.", background:"#0b1220", color:"#e5e7eb" });
    }
  }

  async function resetAll() {
    const result = await Swal.fire({
      title: "ì´ˆê¸°í™”í• ê¹Œìš”?",
      html: "<div class='text-slate-300 text-sm'>ì´ë¦„/ë°°ì¹˜/ë ˆì´ì•„ì›ƒ/ë¹„í™œì„± ìƒíƒœê°€ ê¸°ë³¸ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.</div>",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "ì´ˆê¸°í™”",
      cancelButtonText: "ì·¨ì†Œ",
      background: "#0b1220",
      color: "#e5e7eb",
      customClass: { popup:"rounded-4 border border-white/10", confirmButton:"btn btn-danger", cancelButton:"btn btn-outline-light ms-2" },
      buttonsStyling: false
    });
    if (!result.isConfirmed) return;

    state.title = "ì •ë³´ ìˆ˜ì—…";
    state.layoutMode = "lecture";
    state.rows = 5;
    state.seatCols = 6;
    state.aisleW = 1;
    state.seats = Array.from({ length: TOTAL }, (_, i) => ({
      id: i + 1,
      name: `í•™ìƒ ${String(i + 1).padStart(2, "0")}`,
      inactive: false
    }));

    elRows.value = state.rows;
    elSeatCols.value = state.seatCols;
    elAisleW.value = String(state.aisleW);

    render();
    Swal.fire({ icon:"success", title:"ì´ˆê¸°í™” ì™„ë£Œ", timer:900, showConfirmButton:false, background:"#0b1220", color:"#e5e7eb" });
  }

  function exportCSV() {
    const rows = [
      ["seat_id", "name", "inactive", "layoutMode"],
      ...state.seats.map(s => [s.id, s.name, s.inactive ? "1" : "0", state.layoutMode])
    ];
    const csv = rows.map(r => r.map(cell => `"${String(cell).replaceAll('"','""')}"`).join(",")).join("\n");

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "classroom_seating_30.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    Swal.fire({ icon:"success", title:"CSV ë‹¤ìš´ë¡œë“œ", text:"classroom_seating_30.csv ì €ì¥ë¨", timer:1200, showConfirmButton:false, background:"#0b1220", color:"#e5e7eb" });
  }

  async function setTitle() {
    const { value, isConfirmed } = await Swal.fire({
      title: "ìˆ˜ì—… ì œëª©(ì¹ íŒ)",
      input: "text",
      inputValue: state.title,
      inputPlaceholder: "ì˜ˆ) 2-3ë°˜ ì •ë³´, íŒŒì´ì¬ í”„ë¡œì íŠ¸",
      showCancelButton: true,
      confirmButtonText: "ì ìš©",
      cancelButtonText: "ì·¨ì†Œ",
      background: "#0b1220",
      color: "#e5e7eb",
      inputAttributes: { maxlength: 40 },
      customClass: { popup:"rounded-4 border border-white/10", confirmButton:"btn btn-primary", cancelButton:"btn btn-outline-light ms-2" },
      buttonsStyling: false,
      preConfirm: (v) => {
        const t = (v ?? "").trim();
        if (!t) { Swal.showValidationMessage("ì œëª©ì´ ë¹„ì–´ìˆìœ¼ë©´ ì•ˆ ë©ë‹ˆë‹¤."); return false; }
        return t;
      }
    });
    if (!isConfirmed) return;
    state.title = value;
    render();
  }

  async function toggleAbsentMode() {
    absentMode = !absentMode;
    Swal.fire({
      icon: "info",
      title: absentMode ? "ê²°ì„/ë¹„í™œì„± í† ê¸€ ëª¨ë“œ ON" : "ê²°ì„/ë¹„í™œì„± í† ê¸€ ëª¨ë“œ OFF",
      text: absentMode ? "ì¢Œì„ì„ í´ë¦­í•˜ë©´ ê²°ì„ ì²˜ë¦¬ë©ë‹ˆë‹¤." : "ì¢Œì„ í´ë¦­ ì‹œ ì´ë¦„ ìˆ˜ì •ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.",
      timer: 1400,
      showConfirmButton: false,
      background: "#0b1220",
      color: "#e5e7eb"
    });
    render();
  }

  async function applyLectureLayoutFromUI() {
    const rows = clamp(Number(elRows.value || 5), 1, 10);
    const seatCols = clamp(Number(elSeatCols.value || 6), 2, 10);
    const aisleW = clamp(Number(elAisleW.value || 1), 0, 2);

    const capacity = rows * seatCols;
    if (capacity < TOTAL) {
      await Swal.fire({ icon:"error", title:"ì¢Œì„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤", text:`í˜„ì¬ ì„¤ì •(${seatCols}Ã—${rows})ì€ ${TOTAL}ì„ì„ ë‹´ì„ ìˆ˜ ì—†ì–´ìš”.`, background:"#0b1220", color:"#e5e7eb" });
      elRows.value = state.rows;
      elSeatCols.value = state.seatCols;
      elAisleW.value = String(state.aisleW);
      return;
    }

    state.layoutMode = "lecture";
    state.rows = rows;
    state.seatCols = seatCols;
    state.aisleW = aisleW;

    Swal.fire({ icon:"success", title:"ê°•ì˜ì‹ ë ˆì´ì•„ì›ƒ ì ìš©!", timer:900, showConfirmButton:false, background:"#0b1220", color:"#e5e7eb" });
    render();
  }

  async function switchTemplate(mode) {
    const name = mode === "group4" ? "4ì¸ ëª¨ë‘ (ì„¬)" : mode === "group6" ? "6ì¸ ëª¨ë‘ (ì„¬)" : "ê°•ì˜ì‹";
    const result = await Swal.fire({
      title: `${name}ë¡œ ì „í™˜í• ê¹Œìš”?`,
      text: "ì´ë¦„/ì¢Œì„ ë²ˆí˜¸ëŠ” ìœ ì§€ë˜ê³ , â€˜ë³´ì´ëŠ” ë°°ì¹˜â€™ë§Œ ë°”ë€ë‹ˆë‹¤.",
      icon: "question",
      showCancelButton: true,
      confirmButtonText: "ì „í™˜",
      cancelButtonText: "ì·¨ì†Œ",
      background: "#0b1220",
      color: "#e5e7eb",
      customClass: { popup:"rounded-4 border border-white/10", confirmButton:"btn btn-primary", cancelButton:"btn btn-outline-light ms-2" },
      buttonsStyling: false
    });
    if (!result.isConfirmed) return;

    state.layoutMode = mode;

    // lectureë¡œ ëŒì•„ê°ˆ ë•Œ ê¸°ë³¸ê°’ì´ ì‹«ìœ¼ë©´ ì—¬ê¸°ì„œ ìœ ì§€/ì„¸íŒ… ì¡°ì • ê°€ëŠ¥
    if (mode === "lecture") {
      // í˜„ì¬ UI ê°’ ê·¸ëŒ€ë¡œ ì ìš©(í˜¹ì€ state ê°’ ìœ ì§€)
      // ì—¬ê¸°ì„œëŠ” stateê°€ ê°€ì§„ lecture ê°’ì„ ê·¸ëŒ€ë¡œ ìœ ì§€
    }

    Swal.fire({ icon:"success", title:"ì „í™˜ ì™„ë£Œ!", timer:800, showConfirmButton:false, background:"#0b1220", color:"#e5e7eb" });
    render();
  }

  // Buttons
  document.getElementById("btnTitle").addEventListener("click", setTitle);
  document.getElementById("btnEditAll").addEventListener("click", editAllNames);
  document.getElementById("btnShuffle").addEventListener("click", shuffleSeats);
  document.getElementById("btnSave").addEventListener("click", save);
  document.getElementById("btnLoad").addEventListener("click", load);
  document.getElementById("btnExport").addEventListener("click", exportCSV);
  document.getElementById("btnPrint").addEventListener("click", () => window.print());
  document.getElementById("btnReset").addEventListener("click", resetAll);
  document.getElementById("btnAbsentMode").addEventListener("click", toggleAbsentMode);
  document.getElementById("btnApplyLectureLayout").addEventListener("click", applyLectureLayoutFromUI);

  // NEW Template buttons
  document.getElementById("btnTplLecture").addEventListener("click", () => switchTemplate("lecture"));
  document.getElementById("btnTplGroup4").addEventListener("click", () => switchTemplate("group4"));
  document.getElementById("btnTplGroup6").addEventListener("click", () => switchTemplate("group6"));

  // Init
  render();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
